# build docker images from docker compose and push to docker hub

name: Build, Test, and Push Docker Compose Images
on:
  push:
    branches:
      - main
      - add-docker-action

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push SGE-compatible images to GHCR (linux/amd64)
        env:
          GH_OWNER: ${{ github.repository_owner }}
          GIT_SHA: ${{ github.sha }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euxo pipefail
          DATE_TAG=$(date -u +%Y%m%d)
          # normalize owner and branch to lowercase, sanitize branch for tag
          OWNER_LOWER=$(echo "${GH_OWNER}" | tr '[:upper:]' '[:lower:]')
          BRANCH_TAG=$(echo "${BRANCH_NAME:-unknown}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')
          services=(cath-af-cli script ted-tools)
          for service in "${services[@]}"; do
            echo "Building and pushing ${service} for linux/amd64..."
            IMAGE_BASE=ghcr.io/${OWNER_LOWER}/domain-annotation-pipeline-${service}
            docker buildx build \
              --platform linux/amd64 \
              --tag ${IMAGE_BASE}:sha-${GIT_SHA:0:8} \
              --tag ${IMAGE_BASE}:linux-amd64-${DATE_TAG} \
              --tag ${IMAGE_BASE}:${BRANCH_TAG}-latest \
              --tag ${IMAGE_BASE}:linux-amd64-latest \
              --push \
              docker/${service}
            docker buildx rm || true
          done

      - name: Logout from GHCR
        run: docker logout ghcr.io || true
