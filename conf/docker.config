docker {
    enabled = true
    runOptions = "-v ${launchDir}:/launchDir:ro"
}

process {

    withName: '.*' {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-script:main-latest' // Use GHCR image
        container = "domain-annotation-pipeline-script"
    }

    withName: extract_pdb_from_zip {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-ted-tools:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-ted-tools'
    }

    withName: chop_pdb_from_zip {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-script:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-script'
        memory = '8 GB'
    }

    withName: collect_results {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-script:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-script'
    }

    withName: run_get_consensus {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-ted-tools:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-ted-tools'
    }

    withName: run_stride {
        container = 'domain-annotation-pipeline-cath-af-cli'
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-cath-af-cli:main-latest' // Use GHCR image
    }

    withName: create_md5 {
        container = 'domain-annotation-pipeline-cath-af-cli'
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-cath-af-cli:main-latest' // Use GHCR image
    }

    withName: run_measure_globularity {
        container = 'domain-annotation-pipeline-cath-af-cli'
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-cath-af-cli:main-latest' // Use GHCR image
    }

    withName: run_ted_segmentation {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-ted-tools:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-ted-tools'
        memory = params.project_name == 'git_actions_test' ? '14 GB' : '16 GB'
        cpus = 2
    }

    // ===== Domain quality (from main) =====
    withName: run_domain_quality {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-ted-tools:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-ted-tools'
    }

    withName: run_domain_quality_from_zip {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-ted-tools:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-ted-tools'
    }

    withName: files_from_zip {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-ted-tools:main-latest' // Use GHCR image
        container = "domain-annotation-pipeline-ted-tools"
    }

    // ===== Foldseek (from run_foldseek) =====
    // Use the Steinegger GH container. Note: entrypoint disabled
    // foldseek_exec = 'foldseek_arch' (docker)
    // params.foldseek_exec = '/usr/local/bin/foldseek_avx2' (singularity)
    withName: 'foldseek_create_db|foldseek_run_foldseek|foldseek_run_convertalis' {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-foldseek:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-foldseek:latest'
        memory = params.project_name == 'git_actions_test' ? '14 GB' : '16 GB'
        docker.runOptions = '--entrypoint ""'
    }

    // Let the bespoke parser script run in the script container
    withName: 'foldseek_process_results' {
        //container = 'ghcr.io/uclorengogroup/domain-annotation-pipeline-script:main-latest' // Use GHCR image
        container = 'domain-annotation-pipeline-script'
    }
}
