params.singularity_image_dir = '/SAN/orengolab/bfvd/singularity_images'
//params.scratch_dir = "/SAN/orengolab/bfvd/nextflow_scratch/${System.getenv('USER')}"
params.scratch_dir = false
params.project = params.project ?: 'cath'

executor {
    name = 'sge'
    queueSize = 100
}

// ========== PROCESS SETTINGS ==========
process {

    // ---------- LABEL PROFILES ----------

    // Local processes
    withLabel: local {
        executor = 'local'
    }

    // Generic SGE CPU jobs
    withLabel: sge_low {
        scratch  = params.scratch_dir
        executor = 'sge'
        penv     = { task.cpus > 1 ? 'smp' : '' }

        // Common SGE options for non-GPU jobs
        clusterOptions = {
            def mem  = task.memory ? task.memory.mega : '7000'
            def cpus = task.cpus
            def opts = "-P ${params.project} -S /bin/bash -l tmem=${mem}M,h_vmem=${mem}M"
            if (cpus > 1) opts += " -R y"
            return opts
        }
    }

    // Generic SGE GPU jobs
    withLabel: sge_gpu_high {
        containerOptions = '--nv'  // required for GPU support in containers
        scratch          = params.scratch_dir
        executor         = 'sge'
        penv             = { task.cpus > 1 ? 'smp' : '' }

        // Common SGE options for GPU jobs: use task.memory, add gpu + h_rt
        clusterOptions = {
            def mem  = task.memory ? task.memory.mega : '31000'
            def cpus = task.cpus
            def time = task.time ? task.time.toString() : '23h'
            def opts = "-P ${params.project} -S /bin/bash -l tmem=${mem}M,h_vmem=${mem}M -l gpu=true -l h_rt=${time.replace('h', ':00:00')}"
            if (cpus > 1) opts += " -R y"
            return opts
        }
    }

    // ---------- DEFAULT CONTAINERS ----------

    withName: '.*' {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
    }

    withName: 'foldseek.*' {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-foldseek_latest.sif"
    }

    // ---------- PROCESS-SPECIFIC OVERRIDES ----------

    // SGE CPU, big memory + retries
    withName: chop_pdb {
        memory        = '31GB'
        errorStrategy = 'retry'
        maxRetries    = 2
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
    }

    withName: chop_pdb_from_zip {
        memory        = '8GB'
        errorStrategy = 'retry'
        maxRetries    = 2
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
    }

    withName: get_uniprot_data {
        maxForks      = 5
        errorStrategy = 'retry'
        maxRetries    = 5
    }

    withName: summarise_stride {
        executor = 'local'
    }

    withName: transform_consensus {
        executor = 'local'
    }

    withName: run_get_consensus {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }

    withName: run_filter_consensus {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }

    withName: extract_pdb_from_zip {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }

    withName: run_filter_domains {
        executor = 'local'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }

    // SGE CPU, 15G memory, retries
    withName: run_stride {
        executor      = 'sge'
        memory        = '15GB'
        time          = '12h'
        errorStrategy = 'retry'
        maxRetries    = 2
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }

    withName: run_AF_domain_id {
        executor = 'local'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }

    withName: create_md5 {
        executor = 'sge'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }

    withName: run_measure_globularity {
        executor      = 'sge'
        memory        = '15GB'
        time          = '12h'
        errorStrategy = 'retry'
        maxRetries    = 2
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }

    withName: filter_pdb {
        executor = 'local'   // you had a comment about possibly moving this to SGE
        errorStrategy = 'retry'
        maxRetries    = 3
    }

    // GPU + dynamic memory based on attempt
    withName: run_ted_segmentation {
        executor      = 'sge'
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
        errorStrategy = 'retry'
        maxRetries    = 2

        // 1st attempt: 7 GB, 2nd: 15 GB, 3rd: 31 GB
        memory = { task.attempt == 1 ? 7.GB : task.attempt == 2 ? 15.GB : 31.GB }
        time   = '23h'    // used for documentation; h_rt fixed in label as before
    }
}

// ========== SINGULARITY SETTINGS ==========
singularity {
    enabled      = true
    autoMounts   = true
    mode         = "native"
    envWhitelist = 'CUDA_VISIBLE_DEVICES,SINGULARITYENV_CUDA_VISIBLE_DEVICES'
}
