params.singularity_image_dir = '/SAN/orengolab/bfvd/singularity_images'
//params.scratch_dir = "/SAN/orengolab/bfvd/nextflow_scratch/${System.getenv('USER')}"
params.scratch_dir = false
params.project = params.project ?: 'cath'
params.foldseek_exec = '/usr/local/bin/foldseek_avx2'

// Exclude specific nodes from GPU jobs
params.excluded_gpu_nodes = ['bubba-213-3.local']

executor {
    name = 'sge'
    queueSize = 100
}

// ========== PROCESS SETTINGS ==========
process {

    // ---------- LABEL PROFILES ----------

    // Local processes
    withLabel: local {
        executor = 'local'
    }

    // Generic SGE CPU jobs
    withLabel: sge_low {
        scratch  = params.scratch_dir
        executor = 'sge'
        penv     = { task.cpus > 1 ? 'smp' : '' }

        // Common SGE options for non-GPU jobs
        clusterOptions = {
            def mem  = task.memory ? task.memory.mega : '7000'
            def cpus = task.cpus
            def opts = "-P ${params.project} -S /bin/bash -l tmem=${mem}M,h_vmem=${mem}M"
            if (cpus > 1) opts += " -R y"
            return opts
        }
    }

    // Generic SGE GPU jobs
    withLabel: sge_gpu_high {
        containerOptions = '--nv --env CUDA_VISIBLE_DEVICES=$CUDA_VISIBLE_DEVICES'  // required for GPU support in containers
        scratch          = params.scratch_dir
        executor         = 'sge'
        penv             = { task.cpus > 1 ? 'smp' : '' }

        // Common SGE options for GPU jobs: use task.memory, add gpu + h_rt
        clusterOptions = {
            def mem  = task.memory ? task.memory.mega : '31000'
            def cpus = task.cpus
            def time = task.time ? task.time.toString() : '23h'
            def opts = "-P ${params.project} -S /bin/bash -l tmem=${mem}M,h_vmem=${mem}M -l gpu=true -l h_rt=${time.replace('h', ':00:00')}"
            
            // Exclude specific nodes from GPU jobs
            if (params.excluded_gpu_nodes) {
                def excluded = params.excluded_gpu_nodes.collect { node -> "!${node}" }.join('|')
                opts += " -l h='${excluded}'"
            }
            
            if (cpus > 1) opts += " -R y"
            return opts
        }
    }

    // ---------- DEFAULT CONTAINERS ----------

    withName: '.*' {
        cache     = 'lenient'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
        errorStrategy = 'retry'
        maxRetries = 3
    }

    withName: 'foldseek_create_db|foldseek_run_foldseek|foldseek_run_convertalis' {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-foldseek_latest.sif"
        memory = '15GB'
    }

    // ---------- PROCESS-SPECIFIC OVERRIDES ----------

    // SGE CPU, big memory + retries
    withName: chop_pdb {
        memory        = '31GB'
        errorStrategy = 'retry'
        maxRetries    = 2
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
    }
    
    withName: foldseek_process_results {
        memory        = '15GB'
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
    }

    withName: chop_pdb_from_zip {
        memory        = '15GB'
        errorStrategy = 'retry'
        maxRetries    = 2
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
    }

    withName: get_uniprot_data {
        maxForks      = 2
        errorStrategy = 'retry'
        maxRetries    = 5
    }

    withName: summarise_stride {
        executor = 'local'
    }

    withName: transform_consensus {
        executor = 'local'
    }

    withName: run_get_consensus {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }

    withName: run_filter_consensus {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }

    withName: extract_pdb_from_zip {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }

    withName: run_filter_domains {
        executor = 'local'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }

    // SGE CPU, 15G memory, retries
    withName: run_stride {
        executor      = 'sge'
        memory        = '15GB'
        time          = '12h'
        errorStrategy = 'retry'
        maxRetries    = 2
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }

    withName: run_AF_domain_id {
        executor = 'local'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }

    withName: create_md5 {
        executor = 'sge'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }

    withName: run_measure_globularity {
        executor      = 'sge'
        memory        = '15GB'
        time          = '12h'
        errorStrategy = 'retry'
        maxRetries    = 2
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }

    withName: filter_pdb {
        executor = 'local'   // you had a comment about possibly moving this to SGE
        errorStrategy = 'retry'
        maxRetries    = 3
    }

    // GPU + dynamic memory based on attempt
    withName: run_ted_segmentation {
        executor      = 'sge'
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
        errorStrategy = 'retry'
        maxRetries    = 4

        // 1st attempt: 7 GB, 2nd: 15 GB, 3rd: 31 GB
        // memory = { task.attempt == 1 ? 7.GB : task.attempt == 2 ? 15.GB : 31.GB }
        memory = { task.attempt == 1 ? 31.GB : task.attempt == 2 ? 47.GB : 63.GB }
        time   = '23h'    // used for documentation; h_rt fixed in label as before
    }

    withName: run_domain_quality {
        executor      = 'sge'
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
        errorStrategy = 'retry'
        maxRetries    = 3
        memory        = '31GB'
    }

    withName: run_domain_quality_from_zip {
        executor      = 'sge'
        container     = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
        errorStrategy = 'retry'
        maxRetries    = 3
        memory        = '31GB'
    }

    withName: files_from_zip {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }
}

// ========== SINGULARITY SETTINGS ==========
singularity {
    enabled      = true
    autoMounts   = true
    mode         = "native"
    envWhitelist = 'CUDA_VISIBLE_DEVICES,SINGULARITYENV_CUDA_VISIBLE_DEVICES'
    // make the launch directory available inside the container as read-only
    runOptions = "--bind ${launchDir}:/launchDir:ro"
}
