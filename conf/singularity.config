params.singularity_image_dir = '/SAN/orengolab/bfvd/singularity_images'
params.scratch_dir = "/SAN/orengolab/bfvd/nextflow_scratch/${System.getenv('USER')}"
params.project = params.project ?: 'cath'


executor {
    name = 'sge'
    queueSize = 100
}

// ========== local PROCESS SETTINGS  ==========
process {
    withLabel: local {
        executor = 'local'
    }
    withLabel: sge_low {
        scratch = params.scratch_dir
        executor = 'sge'
        penv = { task.cpus > 1 ? 'smp' : '' }
        clusterOptions = {
            def mem = task.memory ? task.memory.mega : '7000'
            def cpus = task.cpus
            def baseOpts = "-P ${params.project} -S /bin/bash -l tmem=${mem}M,h_vmem=${mem}M "
            def peOpts = cpus > 1 ? " -R y " : ""
            return baseOpts + peOpts
        }
    }

    // ========== GPU PROCESS SETTINGS (SGE) ==========
    withLabel: sge_gpu_high {

        // containerOptions = '--nv --ipc=host --env CUDA_VISIBLE_DEVICES=$CUDA_VISIBLE_DEVICES' // required for GPU support in containers
        containerOptions = '--nv' // required for GPU support in containers
        maxForks = 1
        scratch = params.scratch_dir
        executor = 'sge'
        penv = { task.cpus > 1 ? 'smp' : '' }
        memory = '31GB'
        time = '23h'
        clusterOptions = "-P ${params.project} -S /bin/bash -l tmem=31G,h_vmem=31G -l gpu=true -l h_rt=23:00:00"
    }
    // ========== PROCESS SPECIFIC SETTINGS ==========

    withName: '.*' {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
    }
    withName: 'foldseek.*' {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-foldseek_latest.sif"
    }
    withName: chop_pdb {
        scratch = params.scratch_dir
        executor = 'sge'
        memory = '15GB'
        time = '23h'                // Longer time limit
        penv = { task.cpus > 1 ? 'smp' : '' }
        clusterOptions = {
            def mem = task.memory ? task.memory.mega : '15000'
            def cpus = task.cpus
            def baseOpts = "-P ${params.project} -S /bin/bash -l tmem=${mem}M,h_vmem=${mem}M "
            def peOpts = cpus > 1 ? " -R y " : ""
            return baseOpts + peOpts
        }
        errorStrategy = 'retry'
        maxRetries = 2
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-script_latest.sif"
    }    
    withName: get_uniprot_data {
        maxForks = 2
        errorStrategy = 'retry'
        maxRetries = 5
    }
    withName: summarise_stride {
        executor = 'local'
    }
    withName: transform_consensus {
        executor = 'local'
    }
    withName: run_get_consensus {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }
    withName: run_filter_consensus {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }
    withName: extract_pdb_from_zip {
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }
    withName: run_filter_domains {
        executor = 'local'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
    }
    withName: run_stride {
        scratch = params.scratch_dir
        executor = 'sge'
        memory = '15GB'           // Much more memory
        time = '12h'                // Longer time limit
        penv = { task.cpus > 1 ? 'smp' : '' }
        clusterOptions = {
            def mem = task.memory ? task.memory.mega : '15000'
            def cpus = task.cpus
            def baseOpts = "-P ${params.project} -S /bin/bash -l tmem=${mem}M,h_vmem=${mem}M "
            def peOpts = cpus > 1 ? " -R y " : ""
            return baseOpts + peOpts
        }
        errorStrategy = 'retry'
        maxRetries = 2
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }
    withName: run_AF_domain_id {
        executor = 'local'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }
    withName: run_measure_globularity {
        scratch = params.scratch_dir
        executor = 'sge'
        memory = '15GB'           // Much more memory
        time = '12h'                // Longer time limit
        penv = { task.cpus > 1 ? 'smp' : '' }
        clusterOptions = {
            def mem = task.memory ? task.memory.mega : '15000'
            def cpus = task.cpus
            def baseOpts = "-P ${params.project} -S /bin/bash -l tmem=${mem}M,h_vmem=${mem}M "
            def peOpts = cpus > 1 ? " -R y " : ""
            return baseOpts + peOpts
        }
        errorStrategy = 'retry'
        maxRetries = 2
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-cath-af-cli_latest.sif"
    }
    withName: filter_pdb {
        errorStrategy = 'retry'
        maxRetries = 3
        executor = 'local'  //change this to sge - too slow with local
    }
    withName: run_ted_segmentation {
        executor = 'sge'
        container = "${params.singularity_image_dir}/domain-annotation-pipeline-ted-tools_latest.sif"
        errorStrategy = 'retry'
        maxRetries = 2
        clusterOptions = "-P ${params.project} -S /bin/bash -l tmem=31G,h_vmem=31G -l gpu=true -l h_rt=23:00:00"
    }
}
// ========== SINGULARITY SETTINGS ==========
singularity {
    enabled = true
    autoMounts = true
    mode = "native"
}
